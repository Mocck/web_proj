# âš™ï¸ ä¸€ã€ä¼ ç»Ÿ Django æ˜¯ WSGI æ¨¡å‹ï¼ˆåŒæ­¥é˜»å¡ï¼‰ï¼š

æ¯ä¸ªè¯·æ±‚éƒ½å ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼›

å¦‚æœè¯·æ±‚é‡Œæœ‰é˜»å¡æ“ä½œï¼ˆä¾‹å¦‚æ•°æ®åº“æŸ¥è¯¢ã€å¤–éƒ¨ HTTP è¯·æ±‚ã€æ–‡ä»¶ IOï¼‰ï¼Œè¯¥çº¿ç¨‹ä¼šå¡ä½ï¼›å½“å¹¶å‘é‡ä¸Šå‡æ—¶ï¼Œçº¿ç¨‹æ•°å¾ˆå¿«è€—å°½ã€‚

ä¾‹å¦‚ï¼š

```python
def get_user(request):
    user = User.objects.get(id=1)  # é˜»å¡æŸ¥è¯¢
    return JsonResponse({"name": user.name})
```

å½“æ•°æ®åº“æŸ¥è¯¢æ…¢æ—¶ï¼Œå…¶ä»–è¯·æ±‚å°±å¾—æ’é˜Ÿ


# âš™ï¸ äºŒã€asyncio å¸¦æ¥çš„æ”¹å˜

Python çš„ asyncio æä¾›äº† äº‹ä»¶å¾ªç¯ï¼ˆevent loopï¼‰ï¼Œè®© I/O æ“ä½œå¼‚æ­¥åŒ–ã€‚

åœ¨ Django 3.1+ ä¸­å·²ç»æ”¯æŒ ASGIï¼ˆAsynchronous Server Gateway Interfaceï¼‰ï¼š

ä½ å¯ä»¥å†™ async def view(request): ...

Django ä¸ä¼šä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºçº¿ç¨‹ï¼Œè€Œæ˜¯é€šè¿‡äº‹ä»¶å¾ªç¯åœ¨å•çº¿ç¨‹å†…è°ƒåº¦å¤šä¸ªåç¨‹ã€‚

å¼‚æ­¥ç¤ºä¾‹ï¼š

```python
async def async_view(request):
    await asyncio.sleep(1)  # æ¨¡æ‹ŸIOæ“ä½œ
    return JsonResponse({"msg": "Hello, async!"})
```

å½“æœ‰å¤šä¸ªè¯·æ±‚è¿›å…¥æ—¶ï¼Œä¸€ä¸ªè¯·æ±‚ await æ—¶ï¼ŒDjango ä¼šè‡ªåŠ¨å»æ‰§è¡Œåˆ«çš„è¯·æ±‚é€»è¾‘ã€‚
â†’ æ›´å¥½çš„ CPU åˆ©ç”¨ç‡ + æ›´é«˜å¹¶å‘èƒ½åŠ›ã€‚


     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚        Client (Browser)   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTP Request
                  â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚        Uvicorn Server     â”‚
     â”‚ (åŸºäº asyncio çš„äº‹ä»¶å¾ªç¯)  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ è°ƒç”¨ ASGI æ¥å£
                  â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  Django (ASGI æ¨¡å¼è¿è¡Œ)    â”‚
     â”‚ async def view(request):  â”‚
     â”‚     await asyncio.sleep() â”‚
     â”‚     return response       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

- æ¯ä¸€ä¸ª HTTP è¯·æ±‚éƒ½ä¼šè¢«äº‹ä»¶å¾ªç¯è°ƒåº¦æˆä¸€ä¸ªåç¨‹æ‰§è¡Œã€‚

- æ¯ä¸ª GET è¯·æ±‚å¯¹åº”çš„åç¨‹æ˜¯ç”± Django / ASGI è‡ªåŠ¨åˆ›å»ºçš„ï¼Œä½ ä¸ç”¨è‡ªå·±ä¸ºæ¯ä¸ªè¯·æ±‚å†å®šä¹‰å•ç‹¬çš„åç¨‹ã€‚

- Django async view å¯¹æ¯ä¸ªhttpè¯·æ±‚ä¸€ä¸ªåç¨‹, ä¸åŒè¯·æ±‚çš„åç¨‹ä¹‹é—´å¤©ç„¶å¹¶å‘


## Django çš„è¿è¡Œæ¨¡å¼ï¼ˆä¸¤ç§ä¸–ç•Œï¼‰

å®ƒå®é™…ä¸Šå¯ä»¥é€šè¿‡ ä¸¤ç§è¿è¡Œæ¨¡å¼ å¯åŠ¨ï¼š

| æ¨¡å¼	| åè®®	| å¯åŠ¨æ–¹å¼	| è¿è¡Œç‰¹ç‚¹ |
|-------|------|-----------|---------|
|åŒæ­¥æ¨¡å¼| WSGI| python manage.py runserver|ä¼ ç»Ÿé˜»å¡å¼ï¼ŒåŒæ­¥è§†å›¾|
|å¼‚æ­¥æ¨¡å¼| ASGI |uvicorn myproject.asgi:application|å¼‚æ­¥éé˜»å¡ï¼Œæ”¯æŒ WebSocketã€async view|

```bash
uvicorn {name of your project}.asgi:application --host x.x.x.x --port xxxx
```

```bash
(env)$ uvicorn hello_async.asgi:application --reload
```
The *--reload* flag tells Uvicorn to watch your files for changes and reload if it finds any. That was probably self-explanatory.

### åœ¨ Python ä¸­ï¼Œasync å…³é”®å­—åªèƒ½å‡ºç°åœ¨ä¸‰ç§è¯­æ³•ç»“æ„å‰ï¼š

|ç”¨æ³•   |è¯­æ³•	| ä½œç”¨|
|-|-|-|
|1ï¸âƒ£ å®šä¹‰å¼‚æ­¥å‡½æ•°	|async def func():	|å®šä¹‰ä¸€ä¸ª åç¨‹å‡½æ•°ï¼ˆcoroutine functionï¼‰ï¼Œè°ƒç”¨æ—¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ª åç¨‹å¯¹è±¡ï¼ˆéœ€è¦ await æˆ–äº‹ä»¶å¾ªç¯æ‰§è¡Œï¼‰|
|2ï¸âƒ£ å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨	|async with ...:|	ç”¨äºç®¡ç†å¼‚æ­¥èµ„æºï¼ˆå¦‚è¿æ¥æ± ã€ç½‘ç»œä¼šè¯ï¼‰ï¼Œæ”¯æŒ __aenter__() / __aexit__() å¼‚æ­¥æ–¹æ³•|
|3ï¸âƒ£ å¼‚æ­¥è¿­ä»£å™¨	|async for ... in ...:	|ç”¨äºå¼‚æ­¥éå†ï¼ˆå¦‚é€æ¡è¯»å–ç½‘ç»œæ•°æ®æµã€æ•°æ®åº“æ¸¸æ ‡ç­‰ï¼‰|

# âœ… ä¸‰ã€asyncio æ ¸å¿ƒæœºåˆ¶

## 1ï¸âƒ£ åç¨‹ï¼ˆCoroutineï¼‰= å¯æš‚åœå’Œæ¢å¤æ‰§è¡Œçš„å‡½æ•°ã€‚

ç”¨ async def å®šä¹‰çš„å‡½æ•°ã€‚è¿”å›ä¸€ä¸ª åç¨‹å¯¹è±¡ï¼Œä¸æ˜¯ç«‹å³æ‰§è¡Œã€‚

```python
async def foo():
    print("start")
    await asyncio.sleep(1)
    print("end")

coro = foo()   # ä¸ä¼šæ‰§è¡Œ
asyncio.run(coro)  # å¯åŠ¨æ‰§è¡Œ
```

## 2ï¸âƒ£ awaitï¼ˆç­‰å¾…ï¼‰

await å…³é”®å­—å‘Šè¯‰è§£é‡Šå™¨ï¼šâ€œæˆ‘è¿™é‡Œè¦æ‰§è¡Œä¸€ä¸ªå¯èƒ½å¾ˆè€—æ—¶çš„æ“ä½œï¼ˆæ¯”å¦‚ç½‘ç»œ I/Oï¼‰ï¼Œå…ˆæš‚åœæˆ‘ï¼Œè®©åˆ«äººè·‘ã€‚â€

```python
await asyncio.sleep(2)
```

ä¸ä¼šé˜»å¡æ•´ä¸ªçº¿ç¨‹ï¼Œå®ƒåªæŠŠå½“å‰åç¨‹çš„æ§åˆ¶æƒè¿˜ç»™äº‹ä»¶å¾ªç¯ï¼›äº‹ä»¶å¾ªç¯ä¼šè°ƒåº¦å…¶ä»–åç¨‹ç»§ç»­è¿è¡Œï¼›2 ç§’åå†å›æ¥æ¢å¤æ‰§è¡Œã€‚

## 3ï¸âƒ£ äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰asyncio çš„æ ¸å¿ƒè°ƒåº¦å™¨ï¼›

è´Ÿè´£ï¼š

è¿è¡Œåç¨‹ï¼›ç®¡ç†ä»»åŠ¡çš„æŒ‚èµ·ä¸æ¢å¤ï¼›å“åº” I/O äº‹ä»¶ï¼ˆsocketã€ç½‘ç»œç­‰ï¼‰ã€‚

```python
import asyncio

async def say(word, delay):
    await asyncio.sleep(delay)
    print(word)

async def main():
    await asyncio.gather(
        say("hello", 1),
        say("world", 2)
    )

asyncio.run(main())
```

asyncio.run() åˆ›å»ºä¸€ä¸ª äº‹ä»¶å¾ªç¯ï¼ˆevent loopï¼‰ï¼›å°† main() è¿™ä¸ªåç¨‹å¯¹è±¡å°è£…

æˆä¸€ä¸ª ä¸»Taskï¼›æŠŠå®ƒæ”¾è¿›äº‹ä»¶å¾ªç¯ä¸­è¿è¡Œã€‚

#### äº‹ä»¶å¾ªç¯çš„è¡Œä¸ºï¼š

- t=0: hello ç­‰å¾… 1sï¼Œworld ç­‰å¾… 2s

- t=1: hello è¾“å‡ºï¼Œworld ç»§ç»­ç­‰å¾…

- t=2: world è¾“å‡ºï¼Œå…¨éƒ¨å®Œæˆ

## 4ï¸âƒ£ Taskï¼ˆä»»åŠ¡ï¼‰

Task æ˜¯åŒ…è£…åç¨‹çš„æ‰§è¡Œå•å…ƒã€‚äº‹ä»¶å¾ªç¯é€šè¿‡ Task ç®¡ç†åç¨‹çš„çŠ¶æ€ã€‚

Task æŠŠåç¨‹äº¤ç»™äº‹ä»¶å¾ªç¯æ‰§è¡Œã€‚

```python 
task = asyncio.create_task(foo()) # foo() is a Coroutine !
```

create_task() å°†åç¨‹å¯¹è±¡ foo() å°è£…æˆ Taskï¼Œå¹¶æ³¨å†Œè¿›äº‹ä»¶å¾ªç¯ã€‚

åˆ›å»ºä»»åŠ¡ä¼šç«‹åˆ»äº¤ç»™äº‹ä»¶å¾ªç¯æ‰§è¡Œï¼›ç±»ä¼¼çº¿ç¨‹æ± ä¸­çš„â€œçº¿ç¨‹å¯¹è±¡â€ï¼›

äº‹ä»¶å¾ªç¯åœ¨ç©ºé—²æ—¶ä¼šè½®æµæ‰§è¡Œè¿™äº›ä»»åŠ¡ã€‚

## âœ… æ€»ç»“ä¸€å¥è¯

asyncio çš„æ ¸å¿ƒæœºåˆ¶æ˜¯ï¼šç”¨äº‹ä»¶å¾ªç¯è°ƒåº¦åç¨‹æ‰§è¡Œï¼Œé€šè¿‡ await è®©å‡ºæ§åˆ¶æƒï¼Œå®ç°å•çº¿ç¨‹å¹¶å‘ã€‚

- ä¸€ä¸ª äº‹ä»¶å¾ªç¯ï¼ˆloopï¼‰ ä¸­å¯ä»¥åŒ…å«å¤šä¸ª Taskã€‚

- æ¯ä¸ª Task è´Ÿè´£æ‰§è¡Œä¸€ä¸ª åç¨‹å¯¹è±¡ï¼ˆasync def å®šä¹‰çš„å‡½æ•°çš„å®ä¾‹ï¼‰ã€‚

- async def çš„ main() åªæ˜¯ä¸€ä¸ªé¡¶å±‚åç¨‹ï¼Œç”¨æ¥ await å¤šä¸ªå­ä»»åŠ¡ã€‚

```    
             Event Loop         â†â†’ ä¸€ä¸ªè¿›ç¨‹é‡Œé€šå¸¸åªæœ‰ 1 ä¸ª loop
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚        Task 1            â”‚â† æ¯ä¸ªä»»åŠ¡åŒ…è£¹ä¸€ä¸ªåç¨‹å¯¹è±¡
     â”‚    â””â”€â”€ main() åç¨‹ â”€â”˜    |
     |        Task 2            |
     |    â””â”€â”€ foo() åç¨‹ â”€â”€â”€â”˜   |
     |        Task 3            |
     |    â””â”€â”€ bar() åç¨‹ â”€â”€â”€â”˜   |
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       å¾ªç¯è°ƒåº¦ï¼šè°å¯è¿è¡Œï¼Ÿè°åœ¨ç­‰å¾…ï¼Ÿ
```

```python
import asyncio

async def task_fn(name):
    print(f"ä»»åŠ¡ {name} å¼€å§‹")
    await asyncio.sleep(1)
    print(f"ä»»åŠ¡ {name} ç»“æŸ")

async def main():
    print("main å¯åŠ¨")
    t1 = asyncio.create_task(task_fn("A"))
    t2 = asyncio.create_task(task_fn("B"))
    await t1
    await t2
    print("main ç»“æŸ")

asyncio.run(main())
```

# ğŸ§  ä¸ Django / Uvicorn çš„å…³ç³»

- Uvicorn å¯åŠ¨æ—¶ä¼š**è‡ªåŠ¨åˆ›å»ºäº‹ä»¶å¾ªç¯**ï¼›

- æ‰€ä»¥ Django çš„ ASGI ç¯å¢ƒ **å·²ç»æœ‰ä¸€ä¸ªå…¨å±€çš„ event loop**ï¼Œä¸è¦æ‰‹åŠ¨ **asyncio.run()**

- Djangoï¼ˆASGIï¼‰ çš„å¼‚æ­¥è§†å›¾ **ï¼ˆasync def viewï¼‰ä¼šæ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯**ï¼›

- å½“è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒUvicorn æŠŠè¯·æ±‚äº¤ç»™äº‹ä»¶å¾ªç¯ï¼›

- Django å¼‚æ­¥ view åœ¨ await I/Oï¼ˆå¦‚æ•°æ®åº“/HTTP è¯·æ±‚ï¼‰æ—¶è®©å‡ºæ‰§è¡Œæƒï¼›å…¶ä»–è¯·æ±‚å¾—ä»¥å¹¶å‘æ‰§è¡Œã€‚

# å››ã€å¹¶å‘æ‰§è¡Œå¤šä¸ªåç¨‹

åœ¨ asyncio ä¸­ï¼Œä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼ˆevent loopï¼‰å¯ä»¥åŒæ—¶è°ƒåº¦å¤šä¸ªåç¨‹ï¼ˆcoroutineï¼‰æ‰§è¡Œã€‚

é‚£ä¹ˆé—®é¢˜æ˜¯ï¼š

å¦‚æœæˆ‘æœ‰å¤šä¸ª async å‡½æ•°ï¼Œæƒ³è®©å®ƒä»¬â€œåŒæ—¶å¼€å§‹ã€ä¸€èµ·ç­‰å¾…å®Œæˆâ€ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ

è¿™æ—¶å°±è½®åˆ° asyncio.gather() ä¸Šåœºäº†ã€‚

```
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
foo()  ---> â”‚             â”‚
bar()  ---> â”‚ asyncio.gather â”‚ â†’ ç­‰å¾…æ‰€æœ‰ä»»åŠ¡ç»“æŸ â†’ è¿”å›ç»“æœåˆ—è¡¨
baz()  ---> â”‚             â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

gather() å°†æ¯ä¸ªåç¨‹åŒ…è£…æˆ Task, æŠŠæ‰€æœ‰ä»»åŠ¡æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯, å½“æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆåï¼Œè¿”å›å®ƒä»¬çš„ç»“æœï¼ˆæŒ‰ä¼ å…¥é¡ºåºï¼‰ã€‚

- gather() = æ‰¹é‡åˆ›å»ºä»»åŠ¡

- await = ç­‰å¾…è¿™äº›ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼Œæ‹¿åˆ°æœ€ç»ˆç»“æœ
  
```python
await asyncio.gather() â‰ˆ è‡ªåŠ¨å¸®ä½ å®Œæˆ â€œåˆ›å»ºå¤šä¸ª task + å¹¶å‘æ‰§è¡Œ + await ç­‰å¾…ç»“æœâ€ çš„è¿‡ç¨‹ã€‚
```
## ä¸create_task()åŒºåˆ«

|  |   |
|---|---|
| create_task() | æƒ³è‡ªå·±æ§åˆ¶ä»»åŠ¡æ‰§è¡Œã€å–æ¶ˆã€åå°è¿è¡Œ |
| gather() | æƒ³å¹¶å‘è¿è¡Œå¤šä¸ªä»»åŠ¡å¹¶æ”¶é›†ç»“æœ |

#### ğŸ” é€šå¸¸åœ¨ Django å¼‚æ­¥è§†å›¾æˆ–åå°ä»»åŠ¡ä¸­ï¼š

- è‹¥ä½ åªæ˜¯â€œå¹¶å‘å–ç»“æœâ€ â†’ ç”¨ gather, ä¸€æ¬¡æ€§åˆ›å»ºå¹¶ç­‰å¾…å¤šä¸ªä»»åŠ¡ã€‚

- è‹¥ä½ è¦â€œå¯åŠ¨åå°å­ä»»åŠ¡â€ â†’ ç”¨ create_task, æ‰‹åŠ¨åˆ›å»ºä»»åŠ¡ï¼Œç¨åè‡ªå·± awaitã€‚

```python
from django.http import JsonResponse
import asyncio
import httpx

async def fetch_json(url):
    async with httpx.AsyncClient() as client:
        resp = await client.get(url)
        return resp.json()

async def my_view(request):
    url1 = "https://api.github.com"
    url2 = "https://api.python.org"
    data1, data2 = await asyncio.gather(fetch_json(url1), fetch_json(url2))
    return JsonResponse({"github": data1, "python": data2})
```

# äº”ã€ others
| ç‰¹æ€§     | async for        | await asyncio.gather()     |
| ------ | ---------------- | -------------------------- |
| æ‰§è¡Œé¡ºåº   | é¡ºåº               | å¹¶å‘                         |
| æ¯æ¬¡è¿­ä»£ç­‰å¾… | æ˜¯ï¼Œæ¯æ¬¡è¿­ä»£ await å‰ä¸€ä¸ª | åœ¨ gather å†…éƒ¨è‡ªåŠ¨ await æ‰€æœ‰ä»»åŠ¡å®Œæˆ |
| æ€»è€—æ—¶    | ç´¯åŠ æ¯ä¸ªåç¨‹è€—æ—¶         | â‰ˆ æœ€æ…¢çš„é‚£ä¸ªåç¨‹è€—æ—¶                |
| ä½¿ç”¨åœºæ™¯   | å¼‚æ­¥ç”Ÿæˆå™¨ã€æŒ‰é¡ºåºå¤„ç†æ•°æ®æµ   | å¹¶å‘å¤„ç†å¤šä¸ªç‹¬ç«‹ä»»åŠ¡                 |


âœ… ä¸‰ã€ç¡®è®¤ä½ æ²¡æœ‰æ··ç”¨ sync å’Œ async é€»è¾‘

å¦‚æœåœ¨ async è§†å›¾ä¸­ç”¨äº†é˜»å¡çš„æ•°æ®åº“æŸ¥è¯¢ï¼ˆæ¯”å¦‚ MyModel.objects.all()ï¼‰ï¼Œä¼šè§¦å‘è­¦å‘Šæˆ–é˜»å¡ã€‚

å¼‚æ­¥ç¯å¢ƒä¸‹åº”ä½¿ç”¨ï¼š
```python
from asgiref.sync import sync_to_async

@sync_to_async
def get_data():
    return list(MyModel.objects.all())

async def apps(request):
    data = await get_data()
    return JsonResponse({"data": data})
```